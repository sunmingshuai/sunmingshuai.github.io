<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="分享高质量Tomcat Spring SpringMCV Kafka 高并发相关技术博客"><meta name="keywords" content="Tomcat, Spring, AMQ"><title>ClassPathXmlApplicationContext源码解析一:准备工作 | The Fourty Thieves</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ClassPathXmlApplicationContext源码解析一:准备工作</h1><a id="logo" href="/.">The Fourty Thieves</a><p class="description">学生时代的'自律'不叫自律叫约束 等你真的一个人面对生活所表现出来的才是真正的自己</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索..."></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">ClassPathXmlApplicationContext源码解析一:准备工作</h1><div class="post-meta"><span class="date">Apr 17, 2017</span><span class="category"><a href="/categories/Spring源码分析/">Spring源码分析</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i> Hits</i></i></span><a href="/2017/04/17/ClassPathXmlApplicationContext源码解析一/#comments" class="comment-count"><i class="cloud-tie-join-count"><i class="join-count">0</i></i> 留言</a></div><div class="post-content"><p>其实在web环境中 用到的上下文环境是 <code>XmlWebApplicationContext</code> 但其实对于我们要讲解的内容来说 核心逻辑是一样的 在后面讲解到web环境加载的时候 会讲到<code>XmlWebApplicationContext</code>类的解析 下面几篇博客的内容我们会介绍<code>Spring</code>是怎么构建上下文环境的 也就是<code>ClassPathXmlApplicationContext</code>的源码的过程<br><code>ClassPathXmlApplicationContext</code>类的测试类是<code>ClassPathXmlApplicationContextTests</code> 如果读者能好好利用这个测试类的话 能节省不少阅读源码的时间<br><strong><em>构造函数</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">   //接收配置文件的地址 默认刷新 父容器为null 讲解web环境加载的时候 会讲到父容器的概念</div><div class="line">public ClassPathXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent)</div><div class="line">		throws BeansException &#123;</div><div class="line">	super(parent);</div><div class="line">	setConfigLocations(configLocations);</div><div class="line">	if (refresh) &#123;</div><div class="line">		refresh();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以后讲解web环境加载的时候我们会讲到父子容器的概念 这里只考虑父容器为null的情况 如果路径中含有如<code>${user.dir}</code>的变量 会被处理替换掉 对替换这部分感兴趣的读者可以深入阅读 然后就进入最重要的一个方法<code>refresh()</code><br><strong><em>refresh()</em></strong><br><code>refresh()</code>方法从总体上看 还算比较清晰 用几个大的方法高度概括了<code>refresh()</code>要完成的工作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">public void refresh() throws BeansException, IllegalStateException &#123;</div><div class="line">	synchronized (this.startupShutdownMonitor) &#123;</div><div class="line">		// Prepare this context for refreshing.</div><div class="line">		// 加载前的准备工作:active标记为true；资源必要性验证等 </div><div class="line">		prepareRefresh();</div><div class="line"></div><div class="line">		// 创建DefaultListableBeanFactory 并加载配置文件 转化为BeanDefinition保存</div><div class="line">		ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</div><div class="line"></div><div class="line">		prepareBeanFactory(beanFactory);</div><div class="line"></div><div class="line">		try &#123;</div><div class="line">			//empty</div><div class="line">			postProcessBeanFactory(beanFactory);</div><div class="line"></div><div class="line">			// spring扩展的实现(容器级别) BeanFactoryPostProcessor 在实例化任何用户定义的bean之前 会首先调用BFPP的接口方法</div><div class="line">			// 常见的BFPP:PropertyPlaceholderConfigurer</div><div class="line">			invokeBeanFactoryPostProcessors(beanFactory);</div><div class="line"></div><div class="line">			// spring可扩展的另一个实现:BeanPostProcessor 在调用bean的init-method方法的前后会调用接口方法</div><div class="line">			// 较常见的硬编码的BPP:ApplicationContextAwareProcessor,ApplicationListenerDetector</div><div class="line">			registerBeanPostProcessors(beanFactory);</div><div class="line"></div><div class="line">			//国际化</div><div class="line">			initMessageSource();</div><div class="line"></div><div class="line">			// Initialize event multicaster for this context.</div><div class="line">			initApplicationEventMulticaster();</div><div class="line"></div><div class="line">			// Initialize other special beans in specific context subclasses.</div><div class="line">			//empty</div><div class="line">			onRefresh();</div><div class="line"></div><div class="line">			// Check for listener beans and register them.</div><div class="line">			// 注册listener</div><div class="line">			registerListeners();</div><div class="line"></div><div class="line">			// Instantiate all remaining (non-lazy-init) singletons.</div><div class="line">			// 实例化所有的非懒惰加载的单例</div><div class="line">			finishBeanFactoryInitialization(beanFactory);</div><div class="line"></div><div class="line">			// Last step: publish corresponding event.</div><div class="line">			finishRefresh();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		catch (BeansException ex) &#123;</div><div class="line">			logger.warn(&quot;Exception encountered during context initialization - cancelling refresh attempt&quot;, ex);</div><div class="line"></div><div class="line">			// Destroy already created singletons to avoid dangling resources.</div><div class="line">			destroyBeans();</div><div class="line"></div><div class="line">			// Reset &apos;active&apos; flag.</div><div class="line">			cancelRefresh(ex);</div><div class="line"></div><div class="line">			// Propagate exception to caller.</div><div class="line">			throw ex;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面我们看<code>obtainFreshBeanFactory()#AbstractRefreshableApplicationContext.refreshBeanFactory()</code>方法(<code>obtainFreshBeanFactory()</code>方法中主要逻辑是在<code>refreshBeanFactory()</code>方法 我们就不再列出完整的<code>obtainFreshBeanFactory()</code>方法 以后这样的格式我们用<code>#</code>区分)<br>再此感叹<code>spring</code>代码的优秀 每个方法都是那么的简短清晰 一层一层的深入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">protected final void refreshBeanFactory() throws BeansException &#123;</div><div class="line">// 如果已经加载过的话 先销毁再重新加载</div><div class="line">	if (hasBeanFactory()) &#123;</div><div class="line">		destroyBeans();</div><div class="line">		closeBeanFactory();</div><div class="line">	&#125;</div><div class="line">	try &#123;</div><div class="line">	//实例化一个DefaultListableBeanFactory 这是一个很重要的类</div><div class="line">		DefaultListableBeanFactory beanFactory = createBeanFactory();</div><div class="line">		//设置id</div><div class="line">		beanFactory.setSerializationId(getId());</div><div class="line">		</div><div class="line">		customizeBeanFactory(beanFactory);</div><div class="line">		loadBeanDefinitions(beanFactory);</div><div class="line">		synchronized (this.beanFactoryMonitor) &#123;</div><div class="line">			this.beanFactory = beanFactory;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	catch (IOException ex) &#123;</div><div class="line">		throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">	 * 忽略BeanNameAware  BeanFactoryAware  BeanClassLoaderAware的依赖 spring有设置专门调用setXXX方法的地方</div><div class="line">	 * Create a new AbstractAutowireCapableBeanFactory.</div><div class="line">	 */</div><div class="line">	public AbstractAutowireCapableBeanFactory() &#123;</div><div class="line">		super();</div><div class="line">		ignoreDependencyInterface(BeanNameAware.class);</div><div class="line">		ignoreDependencyInterface(BeanFactoryAware.class);</div><div class="line">		ignoreDependencyInterface(BeanClassLoaderAware.class);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><strong>对于这样的代码 如果不跟踪进去的话 可能会对有些变量的值感到困惑</strong><br><code>createBeanFactory()</code>实例化了一个<code>DefaultListableBeanFactory</code> 在实例化的过程中 其父类 <code>AbstractAutowireCapableBeanFactory</code>的构造函数注册了几个忽略依赖注入的接口 就是说以后对于bean的属性注入的时候 如果在我们注册的忽略接口里面的话 就不再依赖注入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">	protected void customizeBeanFactory(DefaultListableBeanFactory beanFactory) &#123;</div><div class="line">	//是否允许覆盖</div><div class="line">		if (this.allowBeanDefinitionOverriding != null) &#123;</div><div class="line">			beanFactory.setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding);</div><div class="line">		&#125;</div><div class="line">		//是否允许循环引用  循环引用是很重要的一个知识点 我们后面会专门讲解</div><div class="line">		if (this.allowCircularReferences != null) &#123;</div><div class="line">			beanFactory.setAllowCircularReferences(this.allowCircularReferences);</div><div class="line">		&#125;</div><div class="line">		//设置Qualifier注解解析类</div><div class="line">		beanFactory.setAutowireCandidateResolver(new QualifierAnnotationAutowireCandidateResolver());</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>我们看下<code>beanFactory.setAutowireCandidateResolver(new QualifierAnnotationAutowireCandidateResolver())</code>方法 这个方法就是设置<code>autowireCandidateResolver</code>变量 顺便做了一件事情 就是如果该变量继承了<code>BeanFactoryAware</code>的话 调用<code>setBeanFactory()</code>方法 我们从这里就可以看到<code>sping</code>代码优秀的另一个方面是约定习俗<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public void setAutowireCandidateResolver(final AutowireCandidateResolver autowireCandidateResolver) &#123;</div><div class="line">	Assert.notNull(autowireCandidateResolver, &quot;AutowireCandidateResolver must not be null&quot;);</div><div class="line">	if (autowireCandidateResolver instanceof BeanFactoryAware) &#123;</div><div class="line">		if (System.getSecurityManager() != null) &#123;</div><div class="line">			final BeanFactory target = this;</div><div class="line">			AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123;</div><div class="line">				public Object run() &#123;</div><div class="line">					((BeanFactoryAware) autowireCandidateResolver).setBeanFactory(target);</div><div class="line">					return null;</div><div class="line">				&#125;</div><div class="line">			&#125;, getAccessControlContext());</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">		// 调用`setBeanFactory()`方法 this作为参数</div><div class="line">			((BeanFactoryAware) autowireCandidateResolver).setBeanFactory(this);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	//设置变量</div><div class="line">	this.autowireCandidateResolver = autowireCandidateResolver;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面就进入很重要的一个方法了<code>AbstractXmlApplicationContext#loadBeanDefinitions(beanFactory);</code> 载入配置文件 就是根据配置文件做相应的处理 例如将<code>&lt;bean&gt;</code>转化为BeanDefinition保存 这跟Tomcat将<code>server.xml</code>转化为<code>StandardServer</code>是一样的 阅读这部分代码并不需要你很了解是怎么解析xml文档的 因为方法包装的很好的  当然如果读者比较了解xml文档解析的话 那么就更好了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123;</div><div class="line">	// Create a new XmlBeanDefinitionReader for the given BeanFactory.</div><div class="line">	XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);</div><div class="line"></div><div class="line">	// Configure the bean definition reader with this context&apos;s</div><div class="line">	// resource loading environment.</div><div class="line">	beanDefinitionReader.setEnvironment(this.getEnvironment());</div><div class="line">	beanDefinitionReader.setResourceLoader(this);</div><div class="line">	beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this));</div><div class="line"></div><div class="line">	// Allow a subclass to provide custom initialization of the reader,</div><div class="line">	// then proceed with actually loading the bean definitions.</div><div class="line">	initBeanDefinitionReader(beanDefinitionReader);</div><div class="line">	loadBeanDefinitions(beanDefinitionReader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>tips <strong><em>前面几行代码一直在做准备工作 刚阅读源码的读者一定会被这错综复杂的关系所困扰 <code>spring</code>中模块众多,继承 组合关系也是错综复杂 第一次阅读的话 读者可不必太在意这些类之间的委托关系 跟着代码走就可以了 以后阅读第二遍第三遍的时候 再好好研究 比如到现在为止我们都是顺着代码走 并没有从代码设计的角度去讲解</em></strong><br><code>loadBeanDefinitions()</code>方法最终会调用<code>AbstractBeanDefinitionReader#loadBeanDefinitions()</code>方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">public int loadBeanDefinitions(String location, Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException &#123;</div><div class="line">//ClassPathXmlApplicationContext</div><div class="line">	ResourceLoader resourceLoader = getResourceLoader();</div><div class="line">	if (resourceLoader == null) &#123;</div><div class="line">		throw new BeanDefinitionStoreException(</div><div class="line">				&quot;Cannot import bean definitions from location [&quot; + location + &quot;]: no ResourceLoader available&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if (resourceLoader instanceof ResourcePatternResolver) &#123;</div><div class="line">		// Resource pattern matching available.</div><div class="line">		try &#123;</div><div class="line">		// 把String类型的地址封装成Resource类型 方便后续操作</div><div class="line">			Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);</div><div class="line">			int loadCount = loadBeanDefinitions(resources);</div><div class="line">			if (actualResources != null) &#123;</div><div class="line">				for (Resource resource : resources) &#123;</div><div class="line">					actualResources.add(resource);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			if (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location pattern [&quot; + location + &quot;]&quot;);</div><div class="line">			&#125;</div><div class="line">			return loadCount;</div><div class="line">		&#125;</div><div class="line">		catch (IOException ex) &#123;</div><div class="line">			throw new BeanDefinitionStoreException(</div><div class="line">					&quot;Could not resolve bean definition resource pattern [&quot; + location + &quot;]&quot;, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	else &#123;</div><div class="line">		// Can only load single resources by absolute URL.</div><div class="line">		Resource resource = resourceLoader.getResource(location);</div><div class="line">		int loadCount = loadBeanDefinitions(resource);</div><div class="line">		if (actualResources != null) &#123;</div><div class="line">			actualResources.add(resource);</div><div class="line">		&#125;</div><div class="line">		if (logger.isDebugEnabled()) &#123;</div><div class="line">			logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location [&quot; + location + &quot;]&quot;);</div><div class="line">		&#125;</div><div class="line">		return loadCount;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>方法调用<code>AbstractBeanDefinitionReader#loadBeanDefinitions(resource)#loadBeanDefinitions(encodedResource)</code> 我们发现方法调来调去的 却一直没有看到我们想看的内容 一直做的都是准备工作 不急 慢慢来 我们继续往下看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException &#123;</div><div class="line">	Assert.notNull(encodedResource, &quot;EncodedResource must not be null&quot;);</div><div class="line">	if (logger.isInfoEnabled()) &#123;</div><div class="line">		logger.info(&quot;Loading XML bean definitions from &quot; + encodedResource.getResource());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Set&lt;EncodedResource&gt; currentResources = this.resourcesCurrentlyBeingLoaded.get();</div><div class="line">	if (currentResources == null) &#123;</div><div class="line">		currentResources = new HashSet&lt;EncodedResource&gt;(4);</div><div class="line">		this.resourcesCurrentlyBeingLoaded.set(currentResources);</div><div class="line">	&#125;</div><div class="line">	if (!currentResources.add(encodedResource)) &#123;</div><div class="line">		throw new BeanDefinitionStoreException(</div><div class="line">				&quot;Detected cyclic loading of &quot; + encodedResource + &quot; - check your import definitions!&quot;);</div><div class="line">	&#125;</div><div class="line">	try &#123;</div><div class="line">		InputStream inputStream = encodedResource.getResource().getInputStream();</div><div class="line">		try &#123;</div><div class="line">			InputSource inputSource = new InputSource(inputStream);</div><div class="line">			if (encodedResource.getEncoding() != null) &#123;</div><div class="line">				inputSource.setEncoding(encodedResource.getEncoding());</div><div class="line">			&#125;</div><div class="line">			// </div><div class="line">			return doLoadBeanDefinitions(inputSource, encodedResource.getResource());</div><div class="line">		&#125;</div><div class="line">		finally &#123;</div><div class="line">			inputStream.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	catch (IOException ex) &#123;</div><div class="line">		throw new BeanDefinitionStoreException(</div><div class="line">				&quot;IOException parsing XML document from &quot; + encodedResource.getResource(), ex);</div><div class="line">	&#125;</div><div class="line">	finally &#123;</div><div class="line">		currentResources.remove(encodedResource);</div><div class="line">		if (currentResources.isEmpty()) &#123;</div><div class="line">			this.resourcesCurrentlyBeingLoaded.remove();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也是做各种准备工作 终于让我们遇到了我们想要看的代码<code>doLoadBeanDefinitions</code> 代码读到后面 读者就会注意到<code>spring</code>中以do开头的方法才是真正的核心逻辑的开始<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource)</div><div class="line">		throws BeanDefinitionStoreException &#123;</div><div class="line">	try &#123;</div><div class="line">		//获取验证模式 dtd or xsd</div><div class="line">		int validationMode = getValidationModeForResource(resource);</div><div class="line">		//为SAX应用程序提供寻找本地验证文件(dtd/xsd文件) 并将配置文件加载为document保存</div><div class="line">		Document doc = this.documentLoader.loadDocument(</div><div class="line">				inputSource, getEntityResolver(), this.errorHandler, validationMode, isNamespaceAware());</div><div class="line">		return registerBeanDefinitions(doc, resource);</div><div class="line">	&#125;</div><div class="line">	......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然还是山路十八弯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException &#123;</div><div class="line">//DefaultBeanDefinitionDocumentReader </div><div class="line">	BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</div><div class="line">	documentReader.setEnvironment(getEnvironment());</div><div class="line">	int countBefore = getRegistry().getBeanDefinitionCount();</div><div class="line">	//</div><div class="line">	documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</div><div class="line">	return getRegistry().getBeanDefinitionCount() - countBefore;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) &#123;</div><div class="line">	this.readerContext = readerContext;</div><div class="line">	logger.debug(&quot;Loading bean definitions&quot;);</div><div class="line">	Element root = doc.getDocumentElement();</div><div class="line">	//解析的核心部分开始</div><div class="line">	doRegisterBeanDefinitions(root);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">protected void doRegisterBeanDefinitions(Element root) &#123;</div><div class="line">	String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);//profile attribute</div><div class="line">	if (StringUtils.hasText(profileSpec)) &#123;</div><div class="line">		String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</div><div class="line">				profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</div><div class="line">		if (!getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</div><div class="line">			return;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	BeanDefinitionParserDelegate parent = this.delegate;</div><div class="line">	this.delegate = createDelegate(this.readerContext, root, parent);</div><div class="line"></div><div class="line">	preProcessXml(root);</div><div class="line">	parseBeanDefinitions(root, this.delegate);</div><div class="line">	postProcessXml(root);</div><div class="line"></div><div class="line">	this.delegate = parent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在方法<code>createDelegate(this.readerContext, root, parent);</code>中 通过<code>populateDefaults()</code>方法设置了一些例如<code>default-lazy-init</code> <code>default-autowire</code>的值 如果根元素中有设置这些变量的话 将会覆盖默认值 起到全局变量的作用<br><code>preProcessXml(root)</code> <code>postProcessXml(root)</code>都被留空 留给子类实现<br>终于 finally 最终 我们看到了我们一直想看到的代码的影子 <code>parseBeanDefinitions(root, this.delegate)</code><br>要知后事如何 且听下回分解</p>
</div><div class="tags"><a href="/tags/context/">context</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2017/04/16/Tomcat源码分析环境搭建/" class="pre">Tomcat源码分析环境搭建</a><a href="/2017/04/21/ClassPathXmlApplicationContext源码解析二-默认空间元素解析/" class="next">ClassPathXmlApplicationContext源码解析二:默认空间元素解析</a></div><div id="comments"><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring源码分析/">Spring源码分析</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat源码分析/">Tomcat源码分析</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/书单/">书单</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂七杂八/">杂七杂八</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/aop/" style="font-size: 15px;">aop</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/31/Spring问题快问快答/">Spring问题快问快答</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/aop源码解析二-寻找Advisor/">aop源码解析二:寻找Advisor</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/22/aop源码解析一/">aop源码解析一:注册BPP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/aop功能实现口述/">aop功能实现口述</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/Autowired注解工作原理源码解析/">@Autowired注解工作原理源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/13/LimitLatch源码解析/">LimitLatch源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/ClassPathXmlApplicationContext源码解析五-加载单例/">ClassPathXmlApplicationContext源码解析五:加载单例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/07/常用命令行命令详解/">常用命令行命令详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/04/ClassPathXmlApplicationContext源码解析四/">ClassPathXmlApplicationContext源码解析四</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/29/ClassPathXmlApplicationContext源码解析三-BFPP/">ClassPathXmlApplicationContext源码解析三:BFPP</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">孙明帅.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.0"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.0" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>var cloudTieConfig = {
  url: document.location.href, 
  sourceId: "",
  productKey: '7e92867159a646e798100b8a60c85579## 网易云跟帖(productKey)',
  target: "cloud-tie-wrapper"
};</script><script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script></body></html>