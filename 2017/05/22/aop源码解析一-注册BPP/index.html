<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="分享高质量Tomcat Spring SpringMCV Kafka 高并发相关技术博客"><meta name="keywords" content="Tomcat Spring AMQ Kafka Zookeeper"><title>aop源码解析一:注册BPP | The Fourty Thieves</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">aop源码解析一:注册BPP</h1><a id="logo" href="/.">The Fourty Thieves</a><p class="description">可能有点冒失 但我还是觉得当初应该亲自跟她要个电话</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索..."></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">aop源码解析一:注册BPP</h1><div class="post-meta"><span class="date">May 22, 2017</span><span class="category"><a href="/categories/Spring源码分析/">Spring源码分析</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i> Hits</i></i></span><a href="/2017/05/22/aop源码解析一-注册BPP/#comments" class="comment-count"><i class="cloud-tie-join-count"><i class="join-count">0</i></i> 留言</a></div><div class="post-content"><h3 id="本文目的"><a href="#本文目的" class="headerlink" title="本文目的"></a>本文目的</h3><p>如题,标签<code>&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot; expose-proxy=&quot;true&quot;/&gt;</code>注册BPP(AspectJAutoProxyBeanDefinitionParser)源码分析</p>
<blockquote>
<p>并没有介绍过BPP相关内容 这里简单的讲解下 读者心里有个概念就行 等有时间补写Bean的加载与读取的时候 会好好介绍这个重要的类!<br>首先 spring在一些特殊的位置插入了一些处理代码(可能有些读者觉得这句话很<em>眩</em> 不太好理解 我换种表达方式:从加载配置文件到转换成对应的定义类 比如BeanDefinition 再到获取bean 这一整个过程都是spring在做的 他当然能够在任意想插的位置插入代码了) 例如在实例化前后 或者在初始化前后调的方法 这些类一般是BeanPostProcessor的子类 简称BPP</p>
</blockquote>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>对于aop这样的非标准或者称为自定义命名空间的元素 spring会从spring.handlersspring.handlers文件中的对应关系找到相应的处理类 然后通过<code>init()</code>方法注册一些处理器 aop命名空间的处理类是<code>AopNamespaceHandler</code> 我们看一下他的<code>init()</code>方法</p>
<pre><code>public void init() {
    // In 2.0 XSD as well as in 2.1 XSD.
    registerBeanDefinitionParser(&quot;config&quot;, new ConfigBeanDefinitionParser());
    //
    registerBeanDefinitionParser(&quot;aspectj-autoproxy&quot;, new AspectJAutoProxyBeanDefinitionParser());
    registerBeanDefinitionDecorator(&quot;scoped-proxy&quot;, new ScopedProxyBeanDefinitionDecorator());

    // Only in 2.0 XSD: moved to context namespace as of 2.1
    registerBeanDefinitionParser(&quot;spring-configured&quot;, new SpringConfiguredBeanDefinitionParser());
}
</code></pre><p>从上面注册的处理器的关系我们知道 <code>&lt;aop:aspectj-autoproxy&gt;</code>标签的处理器是<code>AspectJAutoProxyBeanDefinitionParser</code> 同样 这是一个继承于<code>BeanDefinitionParser</code>的标准的解析器 我们看一下他的<code>parse()</code>方法</p>
<pre><code>public BeanDefinition parse(Element element, ParserContext parserContext) {
    //注册BPP(AnnotationAwareAspectJAutoProxyCreator)
    AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);
    // 如果有子元素的话 设置属性
    extendBeanDefinition(element, parserContext);
    return null;
}
</code></pre><p><code>parse()</code>方法可以说主要做了一件事情就是注册了一个BPP(BeanPostProcessor) 供后续使用</p>
<blockquote>
<p>有些人看到这里可能就蒙圈了 这什么东西 名字这么长 看到后面的时候又会说这是什么东西  类的名字这么长 然后就会觉得好难 主要是读者阅读代码不多的原因 如果阅读的多了 你就会形成一个感觉：不管这个类名字多奇怪 名字多长 不过是一些基本类型(map list等)的包装而已 为了完成某一个功能所做的封装而已</p>
</blockquote>
<pre><code>//spring中的方法一般都比较清晰 短短的几行代码告诉了你这个方法要做什么事情
public static void registerAspectJAnnotationAutoProxyCreatorIfNecessary(
        ParserContext parserContext, Element sourceElement) {
    //注册BPP(AnnotationAwareAspectJAutoProxyCreator)
    BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(
            parserContext.getRegistry(), parserContext.extractSource(sourceElement));
    //根据xml配置 设置AnnotationAwareAspectJAutoProxyCreator的proxyTargetClass exposeProxy属性
    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);
    //注册组件bean 并暴露给外部
    registerComponentIfNecessary(beanDefinition, parserContext);
}
</code></pre><p>不断的追踪<code>registerAspectJAnnotationAutoProxyCreatorIfNecessary()</code>方法发现 就是注册了个BPP(<code>AspectJAutoProxyBeanDefinitionParser</code>) 不再贴出相关代码 我们看下<code>useClassProxyingIfNecessary()</code>方法</p>
<pre><code>    //处理proxy-target-class 以及 expose-proxy属性
    private static void useClassProxyingIfNecessary(BeanDefinitionRegistry registry, Element sourceElement) {
    if (sourceElement != null) {
        //proxy-target-class true:强制使用CGLIB代理 推荐使用
        boolean proxyTargetClass = Boolean.valueOf(sourceElement.getAttribute(PROXY_TARGET_CLASS_ATTRIBUTE));
        if (proxyTargetClass) {
            AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);
        }
        //expose-proxy true:暴露代理类 解决某些情况下 代理无法完成的情况
        boolean exposeProxy = Boolean.valueOf(sourceElement.getAttribute(EXPOSE_PROXY_ATTRIBUTE));
        if (exposeProxy) {
            AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);
        }
    }
}
</code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>似乎<code>&lt;aop:aspectj-autoproxy&gt;</code>标签做的事情并不多 只是注册了一个BPP 但是这个BPP确实非常重要的! 我们用到的切面编程就依靠这个BPP去驱动实现  后面的文章会介绍这个BPP的源码是怎么实现AOP的</p>
</div><div class="tags"><a href="/tags/aop/">aop</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2017/05/20/aop基本概念/" class="pre">aop基本概念</a><a href="/2017/05/23/aop源码解析二-postProcessBeforeInstantiation/" class="next">aop源码解析二:postProcessBeforeInstantiation</a></div><div id="comments"><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#本文目的"><span class="toc-text">本文目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正文"><span class="toc-text">正文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java并发包/">Java并发包</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Raspberry-Pi/">Raspberry Pi</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring源码分析/">Spring源码分析</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat源码分析/">Tomcat源码分析</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/书单/">书单</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂七杂八/">杂七杂八</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/concurrent/" style="font-size: 15px;">concurrent</a> <a href="/tags/context/" style="font-size: 15px;">context</a> <a href="/tags/aop/" style="font-size: 15px;">aop</a> <a href="/tags/BFPP/" style="font-size: 15px;">BFPP</a> <a href="/tags/jdk动态代理/" style="font-size: 15px;">jdk动态代理</a> <a href="/tags/component-scan/" style="font-size: 15px;">component-scan</a> <a href="/tags/父子容器/" style="font-size: 15px;">父子容器</a> <a href="/tags/兴趣爱好/" style="font-size: 15px;">兴趣爱好</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/31/Spring问题快问快答/">Spring问题快问快答</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/07/AbstractQueuedSynchronizer-队列同步器-实现分析/">AbstractQueuedSynchronizer(队列同步器)实现分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/23/aop源码解析辅助-jdk动态代理/">aop源码解析辅助:jdk动态代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/23/aop源码解析四-代理方法的调用/">aop源码解析四:代理方法的调用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/树莓派安装Ubuntu-server/">树莓派安装Ubuntu server</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/15/为什么要读书/">为什么要读书</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/spring父子容器源码解析二/">spring父子容器源码解析二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/spring父子容器源码解析一/">spring父子容器源码解析一</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/aop源码解析三-postProcessAfterInitialization/">aop源码解析三:postProcessAfterInitialization</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/aop源码解析二-postProcessBeforeInstantiation/">aop源码解析二:postProcessBeforeInstantiation</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">孙明帅.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.0"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.0" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>var cloudTieConfig = {
  url: document.location.href, 
  sourceId: "",
  productKey: '7e92867159a646e798100b8a60c85579## 网易云跟帖(productKey)',
  target: "cloud-tie-wrapper"
};</script><script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script></body></html>